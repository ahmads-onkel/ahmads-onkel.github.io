<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect, remove }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey: "AIzaSyB8eIlsvx6fz7RaVy1EeRSgqVsopqyoeyI",
  authDomain: "ahmad-5ea27.firebaseapp.com",
  databaseURL: "https://ahmad-5ea27-default-rtdb.firebaseio.com",
  projectId: "ahmad-5ea27",
  storageBucket: "ahmad-5ea27.firebasestorage.app",
  messagingSenderId: "168368947306",
  appId: "1:168368947306:web:605abc8ba0b91acfad4a13"
});
const db = getDatabase(app);

/* ================= IDENTITY ================= */
const PID   = Math.random().toString(36).slice(2,10);
const COLOR = ['#ff3d6e','#3dffa0','#4499ff','#ffbf3d','#bf3dff','#ff7a3d','#3dfff0','#ffe333']
  [Math.floor(Math.random()*8)];

/* ================= STATE ================= */
let roomId = '';
let pRef;
let players = {};
let x = innerWidth/2, y = innerHeight/2;
let tx = x, ty = y;
let kills = 0;
let alive = true;
let started = false;
let spawnProt = true;
let lastSend = 0;
let name = 'Mouse';
let intentionalRemove = false;

/* ================= PUBLIC MATCHMAKING (FIXED) ================= */
async function findPublicRoom() {
  return 'pub_' + (Math.floor(Math.random() * 10) + 1);
}

/* ================= JOIN ================= */
window.joinPublic = async () => {
  name = nameInput.value.trim() || 'Mouse';
  roomId = await findPublicRoom();
  startGame();
};

window.createPrivate = () => {
  name = nameInput.value.trim() || 'Mouse';
  let code = roomInput.value.trim().toUpperCase();
  if (!code) code = Math.random().toString(36).slice(2,8).toUpperCase();
  roomId = 'priv_' + code;
  roomInput.value = code;
  roomBadge.style.display = 'block';
  roomBadge.textContent = 'ðŸ“‹ Share code: ' + code;
  startGame();
};

/* ================= START ================= */
function startGame() {
  menu.style.display = 'none';
  hud.style.display = 'block';
  killfeed.style.display = 'block';

  const sp = spawn();
  x = sp.x; y = sp.y; tx = x; ty = y;

  pRef = ref(db, `rooms/${roomId}/players/${PID}`);
  onDisconnect(pRef).remove();

  /* IMPORTANT: spawn immediately */
  set(pRef, {
    x, y,
    color: COLOR,
    name,
    kills,
    spawnProt: true
  });

  onValue(ref(db, `rooms/${roomId}/players`), snap => {
    const data = snap.val() || {};

    if (started && alive && !data[PID] && !intentionalRemove) {
      die();
    }

    players = data;
    renderOthers();
    pcount.textContent = Object.keys(players).length + ' mice';
  });

  started = true;
  spawnProt = true;
  setTimeout(() => spawnProt = false, 1800);
  requestAnimationFrame(loop);
}

/* ================= LOOP ================= */
function loop(ts) {
  requestAnimationFrame(loop);
  if (!alive || !started) return;

  x += (tx - x) * 0.15;
  y += (ty - y) * 0.15;

  x = Math.max(20, Math.min(innerWidth-20, x));
  y = Math.max(20, Math.min(innerHeight-20, y));

  drawSelf();

  if (ts - lastSend > 50) {
    lastSend = ts;

    set(pRef, {
      x: Math.round(x),
      y: Math.round(y),
      color: COLOR,
      name,
      kills,
      spawnProt
    });

    if (!spawnProt) {
      for (const id in players) {
        if (id === PID) continue;
        const p = players[id];
        if (p.spawnProt) continue;
        if (Math.hypot(p.x-x, p.y-y) < 28) {
          kills++;
          killNum.textContent = kills;
          remove(ref(db, `rooms/${roomId}/players/${id}`));
        }
      }
    }
  }
}

/* ================= RENDER ================= */
function drawSelf() {
  let el = document.getElementById('me');
  if (!el) {
    el = document.createElement('div');
    el.id = 'me';
    el.className = 'player-wrap';
    el.innerHTML = `<div class="p-name" style="color:${COLOR}">${name}</div>`;
    document.body.appendChild(el);
  }
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
}

function renderOthers() {
  document.querySelectorAll('.player-wrap:not(#me)').forEach(e => {
    const id = e.dataset.id;
    if (!players[id]) e.remove();
  });

  for (const id in players) {
    if (id === PID) continue;
    const p = players[id];
    let el = document.querySelector(`[data-id="${id}"]`);
    if (!el) {
      el = document.createElement('div');
      el.dataset.id = id;
      el.className = 'player-wrap';
      el.innerHTML = `<div class="p-name" style="color:${p.color}">${p.name}</div>`;
      document.body.appendChild(el);
    }
    el.style.left = p.x + 'px';
    el.style.top  = p.y + 'px';
  }
}

/* ================= DEATH / RESPAWN ================= */
function die() {
  alive = false;
  intentionalRemove = true;
  document.getElementById('me')?.remove();
  respawn.style.display = 'flex';

  let c = 3;
  rspNum.textContent = c;
  const iv = setInterval(() => {
    c--;
    rspNum.textContent = c;
    if (c <= 0) {
      clearInterval(iv);
      respawn.style.display = 'none';
      intentionalRemove = false;
      alive = true;
      spawnProt = true;
      const sp = spawn();
      x = sp.x; y = sp.y;
      set(pRef, { x, y, color:COLOR, name, kills, spawnProt:true });
      setTimeout(() => spawnProt = false, 1800);
    }
  }, 1000);
}

/* ================= INPUT ================= */
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px';
  cursor.style.top  = e.clientY + 'px';
  if (alive) { tx = e.clientX; ty = e.clientY; }
});

/* ================= UTIL ================= */
function spawn() {
  const W = innerWidth, H = innerHeight;
  const s = [
    {x:60,y:60},{x:W-60,y:60},{x:60,y:H-60},{x:W-60,y:H-60}
  ];
  return s[Math.floor(Math.random()*s.length)];
}
</script>
