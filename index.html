<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARENA.EXE</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #000;
      overflow: hidden;
      cursor: none;
      font-family: 'Orbitron', monospace;
      color: #00ff88;
      user-select: none;
    }

    canvas { display: block; }

    /* CUSTOM CROSSHAIR */
    #xhair {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
    }

    /* SCANLINES OVERLAY */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.06) 3px, rgba(0,0,0,0.06) 4px);
      pointer-events: none;
      z-index: 500;
    }

    /* ── MENU ── */
    #menu {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
      background: radial-gradient(ellipse at center, #040f04 0%, #000 70%);
      z-index: 400;
    }

    .title-glitch {
      font-size: clamp(52px, 10vw, 96px);
      font-weight: 900;
      letter-spacing: 0.25em;
      color: #00ff88;
      text-shadow: 0 0 20px #00ff88, 0 0 50px #00ff88, 0 0 100px #00ff88;
      animation: flicker 5s infinite, glitch 8s infinite;
      position: relative;
    }

    @keyframes flicker {
      0%,90%,100%{opacity:1}92%{opacity:.7}94%{opacity:1}96%{opacity:.8}98%{opacity:1}
    }
    @keyframes glitch {
      0%,95%,100%{transform:none;filter:none}
      96%{transform:skewX(-3deg);filter:hue-rotate(90deg)}
      97%{transform:skewX(3deg)}
      98%{transform:none;filter:hue-rotate(0deg)}
    }

    .menu-subtitle {
      font-size: 11px;
      letter-spacing: 0.7em;
      color: rgba(0,255,136,0.35);
      margin-top: -16px;
    }

    .menu-panel {
      border: 1px solid rgba(0,255,136,0.25);
      background: rgba(0,255,136,0.03);
      padding: 32px 36px;
      width: min(380px, 92vw);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }
    .menu-panel::before,.menu-panel::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border-color: #00ff88;
      border-style: solid;
      opacity: 0.5;
    }
    .menu-panel::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
    .menu-panel::after  { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }

    .field-label {
      font-size: 9px;
      letter-spacing: 0.4em;
      color: rgba(0,255,136,0.4);
      text-transform: uppercase;
      margin-top: 6px;
    }

    input {
      background: rgba(0,255,136,0.05);
      border: 1px solid rgba(0,255,136,0.25);
      color: #00ff88;
      padding: 11px 14px;
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      outline: none;
      width: 100%;
      transition: border-color .2s, box-shadow .2s;
    }
    input::placeholder { color: rgba(0,255,136,0.18); }
    input:focus {
      border-color: rgba(0,255,136,.7);
      box-shadow: 0 0 12px rgba(0,255,136,.15);
    }

    .btn-row { display: flex; gap: 8px; margin-top: 10px; }

    .btn {
      flex: 1;
      background: transparent;
      border: 1px solid rgba(0,255,136,.4);
      color: #00ff88;
      padding: 12px;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      cursor: none;
      transition: all .2s;
    }
    .btn.prime { background: rgba(0,255,136,.12); border-color: #00ff88; }
    .btn:hover {
      background: rgba(0,255,136,.15);
      border-color: #00ff88;
      box-shadow: 0 0 20px rgba(0,255,136,.25), inset 0 0 20px rgba(0,255,136,.05);
      text-shadow: 0 0 8px #00ff88;
    }

    .menu-hint {
      font-size: 9px;
      letter-spacing: 0.4em;
      color: rgba(0,255,136,.2);
      text-align: center;
    }

    /* ── DEATH SCREEN ── */
    #death {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 14px;
      background: rgba(0,0,0,.88);
      z-index: 300;
    }

    .death-word {
      font-size: clamp(48px,10vw,80px);
      font-weight: 900;
      color: #ff0044;
      letter-spacing: 0.2em;
      text-shadow: 0 0 30px #ff0044, 0 0 60px #ff0044;
      animation: deathshake .4s ease-out;
    }
    @keyframes deathshake {
      0%,100%{transform:translateX(0)}20%{transform:translateX(-12px)}
      40%{transform:translateX(12px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}
    }

    .death-by { font-size: 12px; color: rgba(255,255,255,.4); letter-spacing: 0.3em; }
    #countdown { font-size: 52px; font-weight: 700; color: #00ff88; text-shadow: 0 0 20px #00ff88; }
    .respawn-label { font-size: 9px; letter-spacing: 0.5em; color: rgba(255,255,255,.25); }

    /* ── HUD ── */
    #hud {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 32px;
      background: linear-gradient(transparent, rgba(0,0,0,.7));
      z-index: 50;
    }

    .hud-stat { text-align: center; }
    .hud-label { font-size: 8px; letter-spacing: 0.4em; color: rgba(0,255,136,.35); }
    .hud-val { font-size: 22px; font-weight: 700; color: #00ff88; text-shadow: 0 0 8px #00ff88; }

    .hp-container { width: 200px; }
    .hp-track {
      width: 100%;
      height: 5px;
      background: rgba(255,255,255,.08);
      margin-top: 6px;
      position: relative;
    }
    .hp-fill {
      height: 100%;
      background: #00ff88;
      box-shadow: 0 0 8px #00ff88;
      transition: width .15s, background .3s;
    }

    /* ── LEADERBOARD ── */
    #lb {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 170px;
      display: none;
      z-index: 50;
    }
    .lb-head {
      font-size: 8px;
      letter-spacing: 0.5em;
      color: rgba(0,255,136,.3);
      border-bottom: 1px solid rgba(0,255,136,.15);
      padding-bottom: 7px;
      margin-bottom: 7px;
    }
    .lb-row {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 3px 0;
      font-size: 10px;
    }
    .lb-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .lb-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: rgba(255,255,255,.6); }
    .lb-k { color: #00ff88; font-weight: 700; font-size: 11px; }
    .lb-me .lb-name { color: #fff; }

    /* ── KILL FEED ── */
    #kfeed {
      position: fixed;
      top: 20px;
      left: 20px;
      display: none;
      flex-direction: column;
      gap: 3px;
      z-index: 50;
      pointer-events: none;
    }
    .kf-row {
      font-size: 10px;
      background: rgba(0,0,0,.65);
      border-left: 2px solid #ff0044;
      padding: 4px 10px;
      animation: kfIn .2s ease;
      letter-spacing: 0.05em;
    }
    @keyframes kfIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:none} }

    /* ── CONTROLS HINT ── */
    #controls-hint {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      letter-spacing: 0.35em;
      color: rgba(0,255,136,.2);
      display: none;
      white-space: nowrap;
    }

    /* ── AMMO INDICATOR ── */
    #ammo {
      position: fixed;
      bottom: 72px;
      right: 24px;
      display: none;
      gap: 3px;
      z-index: 50;
    }
    .ammo-pip {
      width: 6px;
      height: 18px;
      background: rgba(0,255,136,.2);
      transition: background .1s;
    }
    .ammo-pip.ready { background: #00ff88; box-shadow: 0 0 6px #00ff88; }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>

<!-- Crosshair -->
<svg id="xhair" width="28" height="28" viewBox="0 0 28 28" fill="none">
  <circle cx="14" cy="14" r="6" stroke="rgba(0,255,136,0.9)" stroke-width="1.2"/>
  <line x1="14" y1="0" x2="14" y2="8" stroke="rgba(0,255,136,0.7)" stroke-width="1.2"/>
  <line x1="14" y1="20" x2="14" y2="28" stroke="rgba(0,255,136,0.7)" stroke-width="1.2"/>
  <line x1="0" y1="14" x2="8" y2="14" stroke="rgba(0,255,136,0.7)" stroke-width="1.2"/>
  <line x1="20" y1="14" x2="28" y2="14" stroke="rgba(0,255,136,0.7)" stroke-width="1.2"/>
  <circle cx="14" cy="14" r="1.5" fill="rgba(0,255,136,0.9)"/>
</svg>

<!-- Menu -->
<div id="menu">
  <div>
    <div class="title-glitch">ARENA.EXE</div>
    <div class="menu-subtitle">MULTIPLAYER COMBAT</div>
  </div>
  <div class="menu-panel">
    <div class="field-label">Callsign</div>
    <input id="nameInput" placeholder="Enter your name…" maxlength="16" autocomplete="off">
    <div class="field-label">Room Code <span style="color:rgba(0,255,136,.18)">(optional)</span></div>
    <input id="roomInput" placeholder="Leave blank for public" autocomplete="off">
    <div class="btn-row">
      <button class="btn prime" onclick="window.joinPublic()">PUBLIC</button>
      <button class="btn" onclick="window.joinPrivate()">PRIVATE</button>
    </div>
  </div>
  <div class="menu-hint">WASD · MOUSE AIM · CLICK TO SHOOT</div>
</div>

<!-- Death Screen -->
<div id="death">
  <div class="death-word">ELIMINATED</div>
  <div class="death-by" id="death-by">Eliminated by ???</div>
  <div id="countdown">3</div>
  <div class="respawn-label">RESPAWNING</div>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-stat">
    <div class="hud-label">KILLS</div>
    <div class="hud-val" id="hud-kills">0</div>
  </div>
  <div class="hp-container">
    <div class="hud-label">HP</div>
    <div class="hp-track"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
  </div>
  <div class="hud-stat">
    <div class="hud-label">ONLINE</div>
    <div class="hud-val" id="hud-online">0</div>
  </div>
</div>

<!-- Leaderboard -->
<div id="lb">
  <div class="lb-head">LEADERBOARD</div>
  <div id="lb-rows"></div>
</div>

<!-- Kill Feed -->
<div id="kfeed"></div>

<!-- Controls -->
<div id="controls-hint">WASD MOVE · MOUSE AIM · CLICK SHOOT · SHIFT DASH</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect, remove, update, increment }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ── FIREBASE ── */
const firebaseConfig = {
  apiKey: "AIzaSyB8eIlsvx6fz7RaVy1EeRSgqVsopqyoeyI",
  authDomain: "ahmad-5ea27.firebaseapp.com",
  databaseURL: "https://ahmad-5ea27-default-rtdb.firebaseio.com",
  projectId: "ahmad-5ea27",
  storageBucket: "ahmad-5ea27.firebasestorage.app",
  messagingSenderId: "168368947306",
  appId: "1:168368947306:web:605abc8ba0b91acfad4a13"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ── CONSTANTS ── */
const WW = 2400, WH = 1800;       // World size
const PR = 14;                      // Player radius
const SPEED = 5;                    // px/frame
const DASH_SPEED = 18;
const DASH_DUR = 150;               // ms
const DASH_CD = 1200;
const BS  = 0.45;                   // Bullet speed px/ms
const BR  = 5;                      // Bullet radius
const BDMG = 25;                    // Bullet damage
const MAX_HP = 100;
const SHOOT_CD = 180;               // ms
const B_LIFE  = 1600;               // ms bullet lifetime
const SPAWN_PROT = 2200;            // ms

/* ── MAP ── */
const WALLS = [
  // Border
  {x:0,y:0,w:WW,h:20},{x:0,y:WH-20,w:WW,h:20},{x:0,y:0,w:20,h:WH},{x:WW-20,y:0,w:20,h:WH},
  // Top zone
  {x:180,y:180,w:380,h:20},{x:180,y:180,w:20,h:220},
  {x:680,y:100,w:20,h:320},{x:780,y:100,w:280,h:20},
  {x:1100,y:180,w:20,h:280},{x:1180,y:180,w:200,h:20},
  {x:1480,y:100,w:20,h:380},{x:1560,y:100,w:380,h:20},
  {x:2000,y:80,w:20,h:300},{x:2060,y:300,w:280,h:20},
  // Mid zone
  {x:100,y:520,w:280,h:20},{x:380,y:420,w:20,h:200},
  {x:580,y:560,w:380,h:20},{x:960,y:460,w:20,h:240},
  {x:1080,y:620,w:300,h:20},{x:1380,y:520,w:20,h:280},
  {x:1580,y:560,w:380,h:20},{x:1960,y:480,w:20,h:260},
  {x:2080,y:400,w:20,h:200},{x:2160,y:380,w:200,h:20},
  // Lower-mid
  {x:160,y:920,w:380,h:20},{x:160,y:800,w:20,h:200},
  {x:600,y:980,w:20,h:340},{x:680,y:980,w:280,h:20},
  {x:1060,y:880,w:20,h:280},{x:1120,y:920,w:360,h:20},
  {x:1480,y:940,w:20,h:300},{x:1600,y:860,w:280,h:20},
  {x:1880,y:900,w:20,h:340},{x:1980,y:960,w:340,h:20},
  // Bottom zone
  {x:200,y:1280,w:480,h:20},{x:200,y:1280,w:20,h:300},
  {x:780,y:1200,w:20,h:380},{x:880,y:1200,w:360,h:20},
  {x:1280,y:1280,w:20,h:300},{x:1380,y:1180,w:440,h:20},
  {x:1900,y:1300,w:20,h:280},{x:2000,y:1200,w:320,h:20},
  // Centre obstacles
  {x:960,y:780,w:300,h:20},{x:960,y:780,w:20,h:240},{x:960,y:1000,w:300,h:20},{x:1240,y:780,w:20,h:240},
  {x:480,y:1140,w:20,h:180},{x:480,y:1140,w:200,h:20},
  {x:1640,y:1120,w:200,h:20},{x:1820,y:1120,w:20,h:200},
];

/* ── STATE ── */
let roomId = '', playerId = Math.random().toString(36).slice(2,10);
let playerRef;
let pName = '', color = `hsl(${Math.random()*360|0},100%,60%)`;
let px = WW/2, py = WH/2;
let hp = MAX_HP, kills = 0;
let alive = false, spawnProtect = false;
let lastShot = 0, lastSync = 0, lastDash = 0;
let dashing = false, dashEnd = 0, dashVx = 0, dashVy = 0;
let camX = 0, camY = 0;
let screenShake = 0;
let players = {}, bullets = {};
let particles = [];

/* ── INPUT ── */
const keys = {};
let mx = 0, my = 0; // screen mouse
document.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space') e.preventDefault(); });
document.addEventListener('keyup',   e => { keys[e.code] = false; });
document.addEventListener('mousemove', e => {
  mx = e.clientX; my = e.clientY;
  const xh = document.getElementById('xhair');
  xh.style.left = mx + 'px'; xh.style.top = my + 'px';
});
document.addEventListener('mousedown', e => { if(e.button===0 && alive) shoot(); });

/* ── CANVAS ── */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
resize(); addEventListener('resize', resize);

/* ── PUBLIC INTERFACE ── */
window.joinPublic  = () => { pName = document.getElementById('nameInput').value.trim() || 'Ghost'; roomId = 'public'; startGame(); };
window.joinPrivate = () => {
  pName = document.getElementById('nameInput').value.trim() || 'Ghost';
  const code = document.getElementById('roomInput').value.trim();
  roomId = code || 'pvt_' + Math.random().toString(36).slice(2,6);
  startGame();
};

/* ── START ── */
function startGame() {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('hud').style.display = 'flex';
  document.getElementById('lb').style.display = 'block';
  document.getElementById('kfeed').style.display = 'flex';
  document.getElementById('controls-hint').style.display = 'block';

  const base = `arenaV2/${roomId}`;
  playerRef = ref(db, `${base}/players/${playerId}`);
  onDisconnect(playerRef).remove();

  onValue(ref(db, `${base}/players`), snap => {
    players = snap.val() || {};
    if (players[playerId]) kills = players[playerId].kills || kills;
    updateLB();
    document.getElementById('hud-online').textContent = Object.keys(players).length;
  });

  onValue(ref(db, `${base}/bullets`), snap => { bullets = snap.val() || {}; });

  onValue(ref(db, `${base}/kfeed`), snap => {
    const ev = snap.val();
    if (!ev) return;
    const arr = Object.values(ev).sort((a,b) => b.t-a.t).slice(0,5);
    renderKF(arr);
  });

  spawn();
  requestAnimationFrame(loop);
}

/* ── SPAWN ── */
function spawn() {
  // Pick a random open spot
  let tries = 0;
  do {
    px = 80 + Math.random()*(WW-160);
    py = 80 + Math.random()*(WH-160);
    tries++;
  } while (wallHit(px, py, PR+4) && tries < 200);

  hp = MAX_HP;
  alive = true;
  spawnProtect = true;
  dashing = false;
  setTimeout(() => spawnProtect = false, SPAWN_PROT);
  syncPlayer();
}

/* ── WALL HELPERS ── */
function wallHit(x, y, r) {
  for (const w of WALLS) {
    if (x+r > w.x && x-r < w.x+w.w && y+r > w.y && y-r < w.y+w.h) return true;
  }
  return false;
}

/* ── SYNC ── */
function syncPlayer() {
  if (!playerRef) return;
  set(playerRef, { x: Math.round(px), y: Math.round(py), color, name: pName, kills, hp });
}

/* ── SHOOT ── */
function shoot() {
  const now = Date.now();
  if (now - lastShot < SHOOT_CD) return;
  lastShot = now;
  const wx = camX + mx, wy = camY + my;
  const dx = wx - px, dy = wy - py;
  const len = Math.hypot(dx, dy);
  if (!len) return;
  const vx = dx/len*BS, vy = dy/len*BS;
  const bid = Math.random().toString(36).slice(2,10);
  set(ref(db, `arenaV2/${roomId}/bullets/${bid}`), {
    sx: Math.round(px), sy: Math.round(py), vx, vy,
    ownerId: playerId, ownerName: pName, ownerColor: color,
    createdAt: now
  });
}

/* ── BULLET POS ── */
function bPos(b) {
  const age = Date.now() - b.createdAt;
  return { x: b.sx + b.vx*age, y: b.sy + b.vy*age };
}

/* ── MAIN LOOP ── */
let lastTs = 0;
function loop(ts) {
  requestAnimationFrame(loop);
  const dt = Math.min(ts - lastTs, 50);
  lastTs = ts;

  if (alive) {
    movePlayer(ts, dt);
    checkHits();
    cleanOldBullets();
    if (ts - lastSync > 48) { lastSync = ts; syncPlayer(); }
  }

  updateCamera(dt);
  draw(ts);
  updateHUD();
}

/* ── MOVE ── */
function movePlayer(ts, dt) {
  let now = Date.now();

  // DASH (Shift)
  if ((keys['ShiftLeft'] || keys['ShiftRight']) && now - lastDash > DASH_CD && !dashing) {
    let dx = 0, dy = 0;
    if (keys['KeyW'] || keys['ArrowUp'])    dy -= 1;
    if (keys['KeyS'] || keys['ArrowDown'])  dy += 1;
    if (keys['KeyA'] || keys['ArrowLeft'])  dx -= 1;
    if (keys['KeyD'] || keys['ArrowRight']) dx += 1;
    const len = Math.hypot(dx, dy);
    if (len) {
      dashVx = dx/len; dashVy = dy/len;
      dashing = true; dashEnd = now + DASH_DUR; lastDash = now;
      spawnParticles(px - camX, py - camY, color, 12, 3);
    }
  }

  let spd = SPEED;
  if (dashing && now < dashEnd) {
    spd = DASH_SPEED;
    spawnParticles(px - camX, py - camY, color, 2, 1.5);
  } else {
    dashing = false;
  }

  let dx = 0, dy = 0;
  if (dashing) { dx = dashVx; dy = dashVy; }
  else {
    if (keys['KeyW'] || keys['ArrowUp'])    dy -= 1;
    if (keys['KeyS'] || keys['ArrowDown'])  dy += 1;
    if (keys['KeyA'] || keys['ArrowLeft'])  dx -= 1;
    if (keys['KeyD'] || keys['ArrowRight']) dx += 1;
    const len = Math.hypot(dx, dy);
    if (len > 0) { dx /= len; dy /= len; }
  }

  const nx = px + dx*spd, ny = py + dy*spd;
  if (!wallHit(nx, py, PR)) px = nx;
  if (!wallHit(px, ny, PR)) py = ny;
  px = Math.max(PR+22, Math.min(WW-PR-22, px));
  py = Math.max(PR+22, Math.min(WH-PR-22, py));
}

/* ── CAMERA ── */
function updateCamera(dt) {
  const tx = px - canvas.width/2, ty = py - canvas.height/2;
  const smooth = Math.min(1, dt * 0.008);
  camX += (tx - camX) * smooth;
  camY += (ty - camY) * smooth;
  camX = Math.max(0, Math.min(WW - canvas.width,  camX));
  camY = Math.max(0, Math.min(WH - canvas.height, camY));
  if (screenShake > 0) screenShake -= dt * 0.12;
}

/* ── CHECK HITS ── */
function checkHits() {
  if (spawnProtect) return;
  const now = Date.now();
  for (const bid in bullets) {
    const b = bullets[bid];
    if (b.ownerId === playerId) continue;
    const age = now - b.createdAt;
    if (age > B_LIFE) continue;
    const { x: bx, y: by } = bPos(b);
    if (wallHit(bx, by, 0)) continue;
    if (Math.hypot(bx-px, by-py) < PR+BR) {
      remove(ref(db, `arenaV2/${roomId}/bullets/${bid}`));
      hp -= BDMG;
      screenShake = 8;
      spawnParticles(px-camX, py-camY, '#ff4444', 10, 3);
      if (hp <= 0) { hp = 0; die(b.ownerName, b.ownerId, b.ownerColor); return; }
      else syncPlayer();
    }
  }
}

/* ── DIE ── */
function die(killerName, killerId, killerColor) {
  alive = false;
  remove(playerRef);
  spawnParticles(px-camX, py-camY, color, 35, 5);
  screenShake = 20;

  update(ref(db, `arenaV2/${roomId}/players/${killerId}`), { kills: increment(1) });

  const eid = Math.random().toString(36).slice(2,8);
  const kfRef = ref(db, `arenaV2/${roomId}/kfeed/${eid}`);
  set(kfRef, { killer: killerName, kc: killerColor||'#00ff88', victim: pName, vc: color, t: Date.now() });
  setTimeout(() => remove(kfRef), 10000);

  document.getElementById('death').style.display = 'flex';
  document.getElementById('death-by').textContent = `Eliminated by ${killerName}`;
  let c = 3;
  document.getElementById('countdown').textContent = c;
  const iv = setInterval(() => {
    c--;
    if (c <= 0) {
      clearInterval(iv);
      document.getElementById('death').style.display = 'none';
      spawn();
    } else document.getElementById('countdown').textContent = c;
  }, 1000);
}

/* ── CLEAN BULLETS ── */
function cleanOldBullets() {
  const now = Date.now();
  for (const bid in bullets) {
    const b = bullets[bid];
    if (b.ownerId === playerId && now - b.createdAt > B_LIFE)
      remove(ref(db, `arenaV2/${roomId}/bullets/${bid}`));
  }
}

/* ── PARTICLES ── */
function spawnParticles(sx, sy, col, count, maxSpd) {
  for (let i = 0; i < count; i++) {
    const a = Math.random()*Math.PI*2;
    const sp = 0.5 + Math.random()*maxSpd;
    particles.push({ x:sx, y:sy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp,
      life:1, decay:0.018+Math.random()*0.025, r:2+Math.random()*3, color:col });
  }
}

/* ── HUD ── */
function updateHUD() {
  document.getElementById('hud-kills').textContent = kills;
  const pct = Math.max(0, hp/MAX_HP*100);
  const fill = document.getElementById('hp-fill');
  fill.style.width = pct + '%';
  fill.style.background = pct < 30 ? '#ff4444' : pct < 55 ? '#ffaa00' : '#00ff88';
  fill.style.boxShadow = `0 0 8px ${pct<30?'#ff4444':pct<55?'#ffaa00':'#00ff88'}`;
}

function updateLB() {
  const sorted = Object.entries(players).sort(([,a],[,b]) => (b.kills||0)-(a.kills||0)).slice(0,8);
  document.getElementById('lb-rows').innerHTML = sorted.map(([id,p]) =>
    `<div class="lb-row${id===playerId?' lb-me':''}">
      <div class="lb-dot" style="background:${p.color};box-shadow:0 0 5px ${p.color}"></div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-k">${p.kills||0}</div>
    </div>`
  ).join('');
}

function renderKF(arr) {
  document.getElementById('kfeed').innerHTML = arr.map(e =>
    `<div class="kf-row">
      <span style="color:${e.kc||'#00ff88'}">${e.killer}</span>
      <span style="color:rgba(255,255,255,.35)"> ⊘ </span>
      <span style="color:${e.vc||'#ff4444'}">${e.victim}</span>
    </div>`
  ).join('');
}

/* ── DRAW ── */
function draw(ts) {
  const W = canvas.width, H = canvas.height;
  const now = Date.now();

  // Screen shake
  let shakeX = 0, shakeY = 0;
  if (screenShake > 0) {
    shakeX = (Math.random()*2-1)*screenShake*0.5;
    shakeY = (Math.random()*2-1)*screenShake*0.5;
  }

  ctx.save();
  ctx.translate(shakeX, shakeY);

  // Background
  ctx.fillStyle = '#040a04';
  ctx.fillRect(-10, -10, W+20, H+20);

  // Grid (infinite-scroll)
  const gSize = 64;
  const gox = (-camX % gSize + gSize) % gSize;
  const goy = (-camY % gSize + gSize) % gSize;
  ctx.save();
  ctx.strokeStyle = 'rgba(0,255,136,0.035)';
  ctx.lineWidth = 1;
  for (let x = gox - gSize; x < W + gSize; x += gSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = goy - gSize; y < H + gSize; y += gSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }
  ctx.restore();

  // World border glow
  const bx = -camX, by = -camY;
  ctx.save();
  ctx.shadowBlur = 30; ctx.shadowColor = '#00ff88';
  ctx.strokeStyle = 'rgba(0,255,136,0.4)';
  ctx.lineWidth = 2;
  ctx.strokeRect(bx, by, WW, WH);
  ctx.restore();

  // Walls
  for (const w of WALLS) {
    const sx = w.x-camX, sy = w.y-camY;
    if (sx+w.w<0||sx>W||sy+w.h<0||sy>H) continue;
    // Fill
    const grad = ctx.createLinearGradient(sx, sy, sx, sy+w.h);
    grad.addColorStop(0, '#1c2e1c'); grad.addColorStop(1, '#0f180f');
    ctx.fillStyle = grad;
    ctx.fillRect(sx, sy, w.w, w.h);
    // Edge
    ctx.strokeStyle = 'rgba(0,255,136,0.18)';
    ctx.lineWidth = 1;
    ctx.strokeRect(sx+.5, sy+.5, w.w-1, w.h-1);
    // Top glow line
    ctx.fillStyle = 'rgba(0,255,136,0.08)';
    ctx.fillRect(sx, sy, w.w, 2);
  }

  // Bullets
  for (const bid in bullets) {
    const b = bullets[bid];
    const age = now - b.createdAt;
    if (age > B_LIFE) continue;
    const { x: bx2, y: by2 } = bPos(b);
    const sx = bx2-camX, sy = by2-camY;
    if (sx<-20||sx>W+20||sy<-20||sy>H+20) continue;

    // Trail
    const trailMs = 80;
    const t0x = b.sx + b.vx*(age-trailMs) - camX;
    const t0y = b.sy + b.vy*(age-trailMs) - camY;
    const tg = ctx.createLinearGradient(t0x, t0y, sx, sy);
    tg.addColorStop(0, 'rgba(0,0,0,0)');
    tg.addColorStop(1, b.ownerColor || '#fff');
    ctx.save();
    ctx.beginPath(); ctx.moveTo(t0x, t0y); ctx.lineTo(sx, sy);
    ctx.strokeStyle = tg; ctx.lineWidth = 2.5; ctx.stroke();
    ctx.restore();

    // Dot
    ctx.save();
    ctx.shadowBlur = 12; ctx.shadowColor = b.ownerColor || '#fff';
    ctx.beginPath(); ctx.arc(sx, sy, BR, 0, Math.PI*2);
    ctx.fillStyle = b.ownerColor || '#fff'; ctx.fill();
    ctx.restore();
  }

  // Players
  for (const id in players) {
    const p = players[id];
    if (!p) continue;
    const sx = p.x-camX, sy = p.y-camY;
    if (sx<-60||sx>W+60||sy<-60||sy>H+60) continue;
    const isMe = id === playerId;

    // Glow halo
    ctx.save();
    const halo = ctx.createRadialGradient(sx, sy, 0, sx, sy, PR*3);
    halo.addColorStop(0, p.color + '30');
    halo.addColorStop(1, 'transparent');
    ctx.fillStyle = halo;
    ctx.fillRect(sx-PR*3, sy-PR*3, PR*6, PR*6);
    ctx.restore();

    // Body
    ctx.save();
    ctx.shadowBlur = isMe ? 24 : 14;
    ctx.shadowColor = p.color;
    ctx.beginPath(); ctx.arc(sx, sy, PR, 0, Math.PI*2);
    ctx.fillStyle = p.color;
    ctx.fill();
    ctx.restore();

    // Inner shine
    ctx.save();
    const shine = ctx.createRadialGradient(sx-3, sy-4, 1, sx, sy, PR);
    shine.addColorStop(0, 'rgba(255,255,255,0.4)');
    shine.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.beginPath(); ctx.arc(sx, sy, PR, 0, Math.PI*2);
    ctx.fillStyle = shine; ctx.fill();
    ctx.restore();

    // Ring
    ctx.beginPath(); ctx.arc(sx, sy, PR+2, 0, Math.PI*2);
    ctx.strokeStyle = isMe ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 1.2; ctx.stroke();

    // Spawn shield
    if (id === playerId && spawnProtect) {
      const pulse = 0.5 + 0.4*Math.sin(ts*0.006);
      ctx.beginPath(); ctx.arc(sx, sy, PR+9, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(0,200,255,${pulse})`;
      ctx.lineWidth = 2; ctx.stroke();
    }

    // HP bar
    const bw = 38, bh = 4;
    const bxr = sx-bw/2, byr = sy-PR-13;
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(bxr, byr, bw, bh);
    const hpFrac = (p.hp ?? MAX_HP) / MAX_HP;
    const hpCol = hpFrac>0.5 ? '#00ff88' : hpFrac>0.25 ? '#ffaa00' : '#ff4444';
    ctx.save();
    ctx.shadowBlur = 6; ctx.shadowColor = hpCol;
    ctx.fillStyle = hpCol;
    ctx.fillRect(bxr, byr, bw*hpFrac, bh);
    ctx.restore();

    // Name
    ctx.font = '500 9px Orbitron, monospace';
    ctx.textAlign = 'center';
    ctx.fillStyle = isMe ? '#fff' : 'rgba(255,255,255,0.65)';
    ctx.fillText(`${p.name}`, sx, sy-PR-17);
  }

  // Particles
  for (let i = particles.length-1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx; p.y += p.vy;
    p.vx *= 0.9; p.vy *= 0.9;
    p.life -= p.decay;
    if (p.life <= 0) { particles.splice(i,1); continue; }
    const alpha = Math.floor(p.life*255).toString(16).padStart(2,'0');
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r*p.life, 0, Math.PI*2);
    ctx.fillStyle = p.color + alpha; ctx.fill();
  }

  ctx.restore(); // shake

  // Minimap
  drawMinimap(W, H, now);

  // Dash cooldown indicator (bottom-right arc)
  drawDashBar(W, H);
}

function drawMinimap(W, H, now) {
  const mmW = 160, mmH = 120;
  const mmX = W-mmW-16, mmY = H-mmH-70;
  const sx = mmW/WW, sy2 = mmH/WH;

  ctx.save();
  ctx.globalAlpha = 0.75;
  ctx.fillStyle = 'rgba(0,8,0,0.85)';
  ctx.fillRect(mmX, mmY, mmW, mmH);
  ctx.strokeStyle = 'rgba(0,255,136,0.25)';
  ctx.lineWidth = 1; ctx.strokeRect(mmX, mmY, mmW, mmH);

  // Walls
  ctx.fillStyle = 'rgba(0,255,136,0.12)';
  for (const w of WALLS)
    ctx.fillRect(mmX+w.x*sx, mmY+w.y*sy2, Math.max(1,w.w*sx), Math.max(1,w.h*sy2));

  // Players
  for (const id in players) {
    const p = players[id];
    ctx.beginPath(); ctx.arc(mmX+p.x*sx, mmY+p.y*sy2, id===playerId?3.5:2, 0, Math.PI*2);
    ctx.fillStyle = p.color; ctx.fill();
    if (id===playerId) { ctx.shadowBlur=6; ctx.shadowColor=p.color; ctx.fill(); ctx.shadowBlur=0; }
  }

  // Viewport rect
  ctx.strokeStyle = 'rgba(255,255,255,0.18)'; ctx.lineWidth=1;
  ctx.strokeRect(mmX+camX*sx, mmY+camY*sy2, canvas.width*sx, canvas.height*sy2);

  ctx.globalAlpha = 0.45;
  ctx.fillStyle = '#00ff88';
  ctx.font = '7px Orbitron, monospace';
  ctx.textAlign = 'left';
  ctx.fillText('RADAR', mmX+4, mmY-4);
  ctx.restore();
}

function drawDashBar(W, H) {
  if (!alive) return;
  const now = Date.now();
  const frac = Math.min(1, (now - lastDash) / DASH_CD);
  const r = 22, cx2 = W-16-r, cy2 = H-70-r;

  ctx.save();
  ctx.strokeStyle = 'rgba(0,255,136,0.15)';
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.arc(cx2, cy2, r, 0, Math.PI*2); ctx.stroke();

  ctx.strokeStyle = frac >= 1 ? '#00ff88' : '#0088ff';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.arc(cx2, cy2, r, -Math.PI/2, -Math.PI/2 + frac*Math.PI*2);
  ctx.stroke();
  if (frac >= 1) { ctx.shadowBlur = 10; ctx.shadowColor = '#00ff88'; ctx.stroke(); }

  ctx.fillStyle = frac >= 1 ? 'rgba(0,255,136,0.8)' : 'rgba(255,255,255,0.3)';
  ctx.font = '7px Orbitron'; ctx.textAlign = 'center';
  ctx.fillText('DASH', cx2, cy2+3);
  ctx.restore();
}
</script>
</body>
</html>
