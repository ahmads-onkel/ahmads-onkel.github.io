<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect, remove }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ================= FIREBASE ================= */

const app = initializeApp({
  apiKey: "AIzaSyB8eIlsvx6fz7RaVy1EeRSgqVsopqyoeyI",
  authDomain: "ahmad-5ea27.firebaseapp.com",
  databaseURL: "https://ahmad-5ea27-default-rtdb.firebaseio.com",
  projectId: "ahmad-5ea27",
  storageBucket: "ahmad-5ea27.firebasestorage.app",
  messagingSenderId: "168368947306",
  appId: "1:168368947306:web:605abc8ba0b91acfad4a13"
});

const db = getDatabase(app);

/* ================= DOM REFERENCES (FIXES BLANK SCREEN) ================= */

const menu      = document.getElementById('menu');
const hud       = document.getElementById('hud');
const cursor    = document.getElementById('cursor');
const respawn   = document.getElementById('respawn');
const nameInput = document.getElementById('nameInput');
const roomInput = document.getElementById('roomInput');
const killNum   = document.getElementById('kills');

/* ================= CORE STATE ================= */

const PID   = crypto.randomUUID().slice(0,8);
const COLOR = `hsl(${Math.random()*360},80%,60%)`;

let roomId = "";
let pRef;
let players = {};

let x = innerWidth/2;
let y = innerHeight/2;
let tx = x;
let ty = y;

let alive = false;
let spawnProt = false;
let kills = 0;
let lastSend = 0;

/* ================= PUBLIC MATCHMAKING ================= */

async function findPublicRoom() {
  return "public_" + (Math.floor(Math.random()*10)+1);
}

/* ================= JOIN ================= */

window.joinPublic = async () => {
  roomId = await findPublicRoom();
  startGame();
};

window.joinPrivate = () => {
  const code = roomInput.value.trim() || "private";
  roomId = "private_" + code.toLowerCase();
  startGame();
};

/* ================= START GAME ================= */

function startGame() {
  menu.style.display = "none";
  hud.style.display = "block";

  alive = true;
  spawnProt = true;

  pRef = ref(db, `rooms/${roomId}/players/${PID}`);
  onDisconnect(pRef).remove();

  spawn();

  set(pRef, {
    x, y,
    color: COLOR,
    name: nameInput.value || "Player",
    kills,
    spawnProt: true
  });

  setTimeout(() => spawnProt = false, 2000);

  onValue(ref(db, `rooms/${roomId}/players`), snap => {
    players = snap.val() || {};
    render();
  });

  requestAnimationFrame(loop);
}

/* ================= MAIN LOOP ================= */

function loop(ts) {
  requestAnimationFrame(loop);
  if (!alive) return;

  // smooth movement
  x += (tx - x) * 0.15;
  y += (ty - y) * 0.15;

  x = clamp(x, 20, innerWidth - 20);
  y = clamp(y, 20, innerHeight - 20);

  drawSelf();

  if (ts - lastSend > 60) {
    lastSend = ts;

    set(pRef, {
      x: Math.round(x),
      y: Math.round(y),
      color: COLOR,
      name: nameInput.value || "Player",
      kills,
      spawnProt
    });

    checkKills();
  }
}

/* ================= KILL SYSTEM ================= */

function checkKills() {
  if (spawnProt) return;

  for (const id in players) {
    if (id === PID) continue;

    const p = players[id];
    if (p.spawnProt) continue;

    const dist = Math.hypot(p.x - x, p.y - y);

    if (dist < 30) {
      kills++;
      killNum.textContent = kills;
      remove(ref(db, `rooms/${roomId}/players/${id}`));
    }
  }
}

/* ================= RENDER ================= */

function drawSelf() {
  let el = document.getElementById("me");
  if (!el) {
    el = createPlayerElement(PID, COLOR, true);
  }
  el.style.left = x + "px";
  el.style.top  = y + "px";
}

function render() {
  // remove missing players
  document.querySelectorAll(".player").forEach(el => {
    const id = el.dataset.id;
    if (!players[id] && id !== PID) el.remove();
  });

  for (const id in players) {
    if (id === PID) continue;
    const p = players[id];

    let el = document.querySelector(`[data-id="${id}"]`);
    if (!el) {
      el = createPlayerElement(id, p.color);
    }

    el.style.left = p.x + "px";
    el.style.top  = p.y + "px";
  }
}

function createPlayerElement(id, color, isSelf=false) {
  const el = document.createElement("div");
  el.className = "player";
  el.dataset.id = id;
  el.style.position = "absolute";
  el.style.width = "32px";
  el.style.height = "32px";
  el.style.borderRadius = "50%";
  el.style.background = color;
  el.style.transform = "translate(-50%, -50%)";
  el.style.pointerEvents = "none";

  document.body.appendChild(el);
  return el;
}

/* ================= RESPAWN ================= */

function spawn() {
  x = Math.random() * (innerWidth - 100) + 50;
  y = Math.random() * (innerHeight - 100) + 50;
}

/* ================= INPUT ================= */

document.addEventListener("mousemove", e => {
  tx = e.clientX;
  ty = e.clientY;

  cursor.style.left = tx + "px";
  cursor.style.top  = ty + "px";
});

/* ================= UTIL ================= */

function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}
</script>
