<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ahmad Craft</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;}

body{
  font-family:'Inter',sans-serif;
  background:#0f0f0f;
  height:100vh;width:100vw;
  display:flex;overflow:hidden;
  color:#ddd;
  position:relative;
  transition:background .3s,color .3s;
}

#stars{position:fixed;inset:0;z-index:0;pointer-events:none;}

#canvas{flex:1;position:relative;overflow:hidden;z-index:1;}

#logo{
  position:fixed;top:16px;right:320px;
  font-size:22px;font-weight:300;color:inherit;
  line-height:1.1;text-align:right;
  z-index:20;letter-spacing:-.02em;
  pointer-events:none;font-style:italic;
}
#logo strong{font-weight:600;font-style:normal;}

/* FIX: hint centered properly */
.hint{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  text-align:center;color:#444;font-size:14px;line-height:2;
  pointer-events:none;transition:opacity .3s;
  font-weight:300;
}

.cel{
  position:absolute;
  background:#1e1e1e;
  border:1.5px solid #2a2a2a;
  border-radius:8px;
  padding:6px 14px 6px 10px;
  font-size:14px;font-weight:400;
  cursor:grab;user-select:none;
  display:flex;align-items:center;gap:8px;
  white-space:nowrap;
  color:#ddd;
  box-shadow:0 1px 4px rgba(0,0,0,.3);
  transition:box-shadow .15s,border-color .15s,transform .15s;
  z-index:5;
}
.cel:hover{
  transform:scale(1.06) translateY(-2px);
  box-shadow:0 6px 20px rgba(0,0,0,.4);
  border-color:#444;
}
.cel:active{cursor:grabbing;}
.cel.near{border-color:#4a90d9;box-shadow:0 0 0 2px rgba(74,144,217,.3);}
.cel.merging{animation:shrink .12s ease forwards;}
@keyframes shrink{0%{opacity:1}100%{opacity:0;transform:scale(.4)}}
.cel .em{font-size:17px;}

/* Light mode overrides */

#sidebar{
  width:300px;flex-shrink:0;
  border-left:1px solid #2a2a2a;
  background:#111;
  display:flex;flex-direction:column;
  z-index:10;position:relative;
  transition:background .3s,border-color .3s;
}


#chips{
  padding:12px 12px 8px;
  display:flex;flex-wrap:wrap;gap:6px;
  border-bottom:1px solid #2a2a2a;
  max-height:50vh;overflow-y:auto;
  transition:border-color .3s;
}

.chip{
  display:flex;align-items:center;gap:5px;
  padding:5px 10px;
  border:1.5px solid #2a2a2a;
  border-radius:8px;background:#1e1e1e;color:#ddd;
  font-size:13px;cursor:pointer;
  transition:background .1s,border-color .1s,transform .12s,box-shadow .12s;
  user-select:none;white-space:nowrap;
}
.chip:hover{
  background:#252525;border-color:#444;
  transform:scale(1.06) translateY(-1px);
  box-shadow:0 3px 10px rgba(0,0,0,.3);
}
.chip .em{font-size:15px;}
.chip.isnew{border-color:#f97316;background:#1a0e00;}


#sidebar-bottom{
  padding:10px 12px;border-top:1px solid #2a2a2a;
  display:flex;gap:6px;align-items:center;flex-wrap:wrap;
  transition:border-color .3s;
}

.tab-btn{
  display:flex;align-items:center;gap:5px;
  padding:6px 12px;border:1.5px solid #2a2a2a;border-radius:8px;
  background:#1e1e1e;font-size:12px;font-family:'Inter',sans-serif;
  cursor:pointer;color:#999;
  transition:background .1s,transform .12s;white-space:nowrap;
}
.tab-btn:hover{background:#252525;color:#ddd;transform:translateY(-1px);}
.tab-btn.active{background:#252525;border-color:#444;color:#ddd;}

.icon-btn{
  width:32px;height:32px;border:1.5px solid #2a2a2a;border-radius:8px;
  background:#1e1e1e;cursor:pointer;font-size:15px;
  display:flex;align-items:center;justify-content:center;
  color:#ddd;
  transition:background .1s,transform .12s;
}
.icon-btn:hover{background:#252525;transform:scale(1.1);}

#search-wrap{
  padding:8px 12px;border-bottom:1px solid #2a2a2a;
  transition:border-color .3s;
}

#search{
  width:100%;padding:6px 10px 6px 30px;
  border:1.5px solid #2a2a2a;border-radius:8px;
  font-size:13px;font-family:'Inter',sans-serif;
  outline:none;background:#1e1e1e;color:#ddd;
  transition:border-color .15s;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:8px center;
}
#search:focus{border-color:#555;}
#search::placeholder{color:#555;}

#bottom-icons{
  position:fixed;bottom:16px;right:320px;
  display:flex;gap:12px;z-index:20;
}
.bicon{
  width:36px;height:36px;border-radius:50%;
  background:#1e1e1e;border:1.5px solid #2a2a2a;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;cursor:pointer;
  box-shadow:0 1px 4px rgba(0,0,0,.3);
  transition:background .1s,transform .15s,box-shadow .15s;
}
.bicon:hover{background:#252525;transform:scale(1.15) translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.4);}

#toast{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%);
  background:#111;color:#fff;
  padding:9px 18px;border-radius:8px;
  font-size:13px;font-weight:500;
  display:none;align-items:center;gap:8px;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
  white-space:nowrap;z-index:999;
  border:1.5px solid #2a2a2a;
}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
#toast .tnew{font-size:9px;color:#f97316;font-weight:700;letter-spacing:.06em;}

#spinner{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%);
  width:20px;height:20px;
  border:2px solid #333;border-top-color:#888;
  border-radius:50%;animation:spin .6s linear infinite;
  display:none;z-index:100;
}
@keyframes spin{to{transform:translateX(-50%) rotate(360deg)}}

/* FIX: recipe popup with dark/light support */
#recipe-popup{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#111;border:1.5px solid #2a2a2a;border-radius:12px;
  color:#ddd;
  padding:24px 28px;box-shadow:0 8px 40px rgba(0,0,0,.5);
  display:none;flex-direction:column;align-items:center;
  z-index:500;min-width:220px;text-align:center;cursor:pointer;
}

#count-lbl{font-size:11px;color:#555;padding:6px 12px;}

@keyframes spawnIn{
  0%{opacity:0;transform:scale(.5) translateY(10px);}
  70%{transform:scale(1.08) translateY(-2px);}
  100%{opacity:1;transform:scale(1) translateY(0);}
}
@keyframes chipIn{
  0%{opacity:0;transform:scale(.8);}
  70%{transform:scale(1.05);}
  100%{opacity:1;transform:scale(1);}
}

@keyframes mergeFlash{
  0%{box-shadow:0 0 0 0 rgba(255,200,50,.9);}
  50%{box-shadow:0 0 0 14px rgba(255,200,50,0);}
  100%{box-shadow:0 0 0 0 rgba(255,200,50,0);}
}
.cel.merge-flash{animation:mergeFlash .45s ease;}

/* ‚îÄ‚îÄ PANELS (dark by default, adapt to light) ‚îÄ‚îÄ */
.panel{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:#111;border:1.5px solid #2a2a2a;border-radius:16px;
  padding:24px;z-index:9999;min-width:340px;max-width:90vw;max-height:80vh;
  overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,.6);
  font-family:Inter,sans-serif;color:#ddd;display:none;
  transition:background .3s;
}

.panel-title{font-size:15px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.panel-close{background:none;border:none;color:#666;font-size:18px;cursor:pointer;transition:color .15s;}
.panel-close:hover{color:#ddd;}

.ach-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 12px;border-radius:10px;margin-bottom:6px;
  background:#1a1a1a;border:1.5px solid #2a2a2a;
  transition:border-color .2s;
}
.ach-item.unlocked{border-color:#f5c842;background:#1a1800;}
.ach-icon{font-size:24px;flex-shrink:0;}
.ach-info .ach-name{font-size:13px;font-weight:600;}
.ach-info .ach-desc{font-size:11px;color:#666;margin-top:2px;}
.ach-item.unlocked .ach-desc{color:#f5c842;}
.ach-lock{font-size:18px;margin-left:auto;color:#333;}
.ach-item.unlocked .ach-lock{color:#f5c842;}

.stat-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 0;border-bottom:1px solid #1e1e1e;font-size:13px;
}
.stat-row:last-child{border-bottom:none;}
.stat-label{color:#666;}
.stat-value{font-weight:600;color:#ddd;font-size:15px;}

.chip-star{
  font-size:12px;margin-left:auto;opacity:.25;cursor:pointer;
  transition:opacity .15s,transform .15s;flex-shrink:0;
}
.chip-star:hover{opacity:1;transform:scale(1.2);}
.chip-star.active{opacity:1;color:#f5c842;}

#ach-toast{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:#1a1800;border:1.5px solid #f5c842;color:#f5c842;
  padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;
  display:none;align-items:center;gap:8px;z-index:10000;
  box-shadow:0 4px 20px rgba(245,200,66,.25);white-space:nowrap;
  animation:tin .3s ease;
}

/* nav buttons */
#sidebar-nav{
  display:flex;gap:4px;padding:8px 12px;border-bottom:1px solid #2a2a2a;
  transition:border-color .3s;
}

.nav-btn{
  flex:1;padding:6px 4px;background:#1e1e1e;border:1.5px solid #2a2a2a;
  border-radius:8px;font-size:11px;font-family:Inter,sans-serif;
  color:#888;cursor:pointer;text-align:center;
  transition:all .15s;
}
.nav-btn:hover{background:#252525;color:#ddd;border-color:#444;}
</style>
</head>
<body>

<canvas id="stars"></canvas>

<div id="canvas">
  <div class="hint" id="hint">Ziehe Elemente auf die Fl√§che<br>und kombiniere zwei miteinander</div>
</div>

<div id="sidebar">
  <div id="sidebar-nav">
    <button class="nav-btn" onclick="showAchievements()">üèÜ Erfolge</button>
    <button class="nav-btn" onclick="showFavorites()">‚≠ê Favoriten</button>
    <button class="nav-btn" onclick="showStats()">üìä Statistik</button>
  </div>
  <div id="chips"></div>
  <div id="search-wrap">
    <input id="search" placeholder="Suchen..." oninput="filterList()">
  </div>
  <div id="count-lbl"></div>
  <div style="flex:1"></div>
  <div id="sidebar-bottom">
    <button class="tab-btn active" id="tab-disc" onclick="setTab('disc')">‚öó Entdeckungen</button>
    <button class="tab-btn" id="tab-time" onclick="setTab('time')">üïê Zeit</button>
    <button class="tab-btn" onclick="sortToggle()">‚Üï</button>
    <button class="icon-btn" onclick="resetAll()" title="Zur√ºcksetzen">üóë</button>
  </div>
</div>

<div id="bottom-icons">
  <div class="bicon" title="Fl√§che leeren" onclick="clearCanvas()">üßπ</div>
</div>

<div id="logo"><strong>Ahmad</strong><br>Craft</div>
<div id="toast"></div>
<div id="spinner"></div>
<div id="recipe-popup"></div>

<div id="ach-panel" class="panel">
  <div class="panel-title">üèÜ Erfolge <button class="panel-close" onclick="closePanel('ach-panel')">‚úï</button></div>
  <div id="ach-list"></div>
</div>
<div id="stats-panel" class="panel">
  <div class="panel-title">üìä Statistiken <button class="panel-close" onclick="closePanel('stats-panel')">‚úï</button></div>
  <div id="stats-list"></div>
</div>
<div id="fav-panel" class="panel">
  <div class="panel-title">‚≠ê Favoriten <button class="panel-close" onclick="closePanel('fav-panel')">‚úï</button></div>
  <div id="fav-list"></div>
</div>
<div id="ach-toast"></div>

<script>
'use strict';

const STARTERS = [
  {emoji:'üíß', name:'Wasser',  ts: 0},
  {emoji:'üî•', name:'Feuer',   ts: 1},
  {emoji:'üå¨Ô∏è', name:'Wind',    ts: 2},
  {emoji:'üåç', name:'Erde',    ts: 3},
];

let discovered = [];
let recipes    = {};
let items      = [];
let nextId     = 0;
let drag       = null, dox = 0, doy = 0;
let busy       = false;
let toastT     = null;
let eHeld      = false, numBuffer = '', numTimer = null;
let tabMode    = 'disc';
let dark       = true;
let favorites  = [];
let achUnlocked= [];
let totalMerges= 0;
let sessionStart = Date.now();
let secretBuffer = '';
const SECRET   = '22112011';

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
(function(){
  try {
    const d = localStorage.getItem('ac_de_v2');
    const r = localStorage.getItem('ac_de_v2_recipes');
    discovered = d ? JSON.parse(d) : [...STARTERS];
    recipes    = r ? JSON.parse(r) : {};
  } catch { discovered=[...STARTERS]; recipes={}; }
  // Ensure starters always exist and have timestamps
  STARTERS.forEach(s => {
    if (!discovered.find(e => e.name === s.name)) discovered.unshift(s);
  });
  try { favorites   = JSON.parse(localStorage.getItem('ac_favs')  || '[]'); } catch {}
  try { achUnlocked = JSON.parse(localStorage.getItem('ac_ach')   || '[]'); } catch {}
  try { totalMerges = parseInt(localStorage.getItem('ac_merges')  || '0'); } catch {}
  renderList();
  initStars();
  // Start in dark mode (already default CSS)


})();

function save(){
  try {
    localStorage.setItem('ac_de_v2', JSON.stringify(discovered));
    localStorage.setItem('ac_de_v2_recipes', JSON.stringify(recipes));
  } catch {}
}

function closePanel(id){ document.getElementById(id).style.display='none'; }

/* ‚îÄ‚îÄ STARS ‚îÄ‚îÄ */
function initStars(){
  const cv = document.getElementById('stars');
  const ctx = cv.getContext('2d');
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  const stars = Array.from({length:100}, () => ({
    x: Math.random()*cv.width, y: Math.random()*cv.height,
    r: Math.random()*1.5+.3, op: Math.random()*.4+.1,
    vx: (Math.random()-.5)*.07, vy: (Math.random()-.5)*.07
  }));
  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    stars.forEach(s => {
      s.x += s.vx; s.y += s.vy;
      if(s.x<0) s.x=cv.width; if(s.x>cv.width) s.x=0;
      if(s.y<0) s.y=cv.height; if(s.y>cv.height) s.y=0;
    });
    for(let i=0;i<stars.length;i++){
      for(let j=i+1;j<stars.length;j++){
        const dx=stars[i].x-stars[j].x, dy=stars[i].y-stars[j].y;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<110){
          ctx.strokeStyle=`rgba(${dark?'150,150,180':'100,100,120'},${(1-d/110)*(dark?.2:.12)})`;
          ctx.lineWidth=.5;
          ctx.beginPath();ctx.moveTo(stars[i].x,stars[i].y);ctx.lineTo(stars[j].x,stars[j].y);ctx.stroke();
        }
      }
    }
    stars.forEach(s => {
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(${dark?'160,160,180':'80,80,100'},${s.op})`;ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
  window.addEventListener('resize', () => { cv.width=window.innerWidth; cv.height=window.innerHeight; });
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
function sortedByAZ() { return [...discovered].sort((a,b)=>a.name.localeCompare(b.name,'de')); }
// FIX: properly sort by time using ts (timestamp)
function sortedByTime(){ return [...discovered].sort((a,b)=>(b.ts||0)-(a.ts||0)); }

function renderList(f=''){
  const chips = document.getElementById('chips');
  chips.innerHTML = '';
  const fl = f.toLowerCase();
  const src = tabMode==='disc' ? sortedByAZ() : sortedByTime();
  const filtered = src.filter(e => !fl || e.name.toLowerCase().includes(fl) || e.emoji.includes(fl));
  filtered.forEach((el, idx) => {
    const d = document.createElement('div');
    d.className = 'chip' + (el.isNew?' isnew':'');
    d.innerHTML = `<span class="em">${el.emoji}</span><span>${el.name}</span>`;
    // spawn handled by mousedown/mouseup
    // drag from sidebar to canvas
    d.addEventListener('mousedown', e => {
      const startX=e.clientX, startY=e.clientY;
      let ghost=null, moved=false;
      const onMove = ev => {
        if(!moved && Math.abs(ev.clientX-startX)<5 && Math.abs(ev.clientY-startY)<5) return;
        moved=true;
        if(!ghost){
          ghost=document.createElement('div');
          ghost.className='cel';
          ghost.innerHTML=`<span class="em">${el.emoji}</span><span>${el.name}</span>`;
          ghost.style.cssText='position:fixed;z-index:9999;pointer-events:none;opacity:.85;';
          document.body.appendChild(ghost);
        }
        ghost.style.left=(ev.clientX-60)+'px';
        ghost.style.top=(ev.clientY-18)+'px';
      };
      const onUp = ev => {
        document.removeEventListener('mousemove',onMove);
        document.removeEventListener('mouseup',onUp);
        if(ghost) ghost.remove();
        if(!moved){ spawn(el); return; }
        const cv=document.getElementById('canvas');
        const r=cv.getBoundingClientRect();
        let x=ev.clientX-r.left-60, y=ev.clientY-r.top-18;
        x=Math.max(10,Math.min(r.width-140,x));
        y=Math.max(10,Math.min(r.height-60,y));
        spawn(el,x,y);
      };
      document.addEventListener('mousemove',onMove);
      document.addEventListener('mouseup',onUp);
    });
    d.style.animation=`chipIn .25s cubic-bezier(.34,1.3,.64,1) ${Math.min(idx*0.025,0.3)}s both`;
    // star button
    const star=document.createElement('span');
    star.className='chip-star'+(favorites.includes(el.name)?' active':'');
    star.textContent='‚≠ê';
    star.title='Favorit';
    star.onclick=e=>{e.stopPropagation();toggleFav(el.name);};
    d.appendChild(star);
    chips.appendChild(d);
  });
  const txt = `Suchen (${filtered.length}) Elemente...`;
  document.getElementById('search').placeholder = txt;
  document.getElementById('count-lbl').textContent = discovered.length + ' Elemente entdeckt';
}

function filterList(){ renderList(document.getElementById('search').value); }
function setTab(t){
  tabMode = t;
  document.getElementById('tab-disc').classList.toggle('active', t==='disc');
  document.getElementById('tab-time').classList.toggle('active', t==='time');
  renderList(document.getElementById('search').value);
}
function sortToggle(){ setTab(tabMode==='disc'?'time':'disc'); }

/* ‚îÄ‚îÄ SPAWN ‚îÄ‚îÄ */
function spawn(el, x, y){
  const cv = document.getElementById('canvas');
  const r  = cv.getBoundingClientRect();
  if(x===undefined) x = 80 + Math.random()*(r.width-250);
  if(y===undefined) y = 60 + Math.random()*(r.height-120);
  const div = document.createElement('div');
  div.className = 'cel';
  div.innerHTML = `<span class="em">${el.emoji}</span><span>${el.name}</span>`;
  div.style.left = x+'px'; div.style.top = y+'px';
  div.style.animation='spawnIn .35s cubic-bezier(.34,1.4,.64,1) forwards';
  const it = {id:nextId++, emoji:el.emoji, name:el.name, x, y, div};
  items.push(it);
  cv.appendChild(div);
  document.getElementById('hint').style.opacity = '0';
  div.addEventListener('mousedown', e=>startDrag(e,it));
  div.addEventListener('touchstart', e=>startDragT(e,it),{passive:false});
  return it;
}

/* ‚îÄ‚îÄ DRAG ‚îÄ‚îÄ */
function startDrag(e,it){ e.preventDefault(); drag=it; const r=it.div.getBoundingClientRect(); dox=e.clientX-r.left; doy=e.clientY-r.top; it.div.style.zIndex=50; }
function startDragT(e,it){ e.preventDefault(); const t=e.touches[0]; drag=it; const r=it.div.getBoundingClientRect(); dox=t.clientX-r.left; doy=t.clientY-r.top; it.div.style.zIndex=50; }
function move(cx,cy){
  if(!drag) return;
  const r=document.getElementById('canvas').getBoundingClientRect();
  drag.x=cx-r.left-dox; drag.y=cy-r.top-doy;
  drag.div.style.left=drag.x+'px'; drag.div.style.top=drag.y+'px';
  items.forEach(o=>{if(o.id===drag.id)return;o.div.classList.toggle('near',dist(drag,o)<70);});
}
document.addEventListener('mousemove',e=>move(e.clientX,e.clientY));
document.addEventListener('touchmove',e=>move(e.touches[0].clientX,e.touches[0].clientY),{passive:true});
document.addEventListener('mouseup',end);
document.addEventListener('touchend',end);

function end(){
  if(!drag)return;
  items.forEach(o=>o.div.classList.remove('near'));
  // teleport if outside
  const cv=document.getElementById('canvas');
  const r=cv.getBoundingClientRect();
  let changed=false;
  if(drag.x<0){drag.x=20;changed=true;}
  if(drag.y<0){drag.y=20;changed=true;}
  if(drag.x>r.width-140){drag.x=r.width-150;changed=true;}
  if(drag.y>r.height-50){drag.y=r.height-60;changed=true;}
  if(changed){drag.div.style.left=drag.x+'px';drag.div.style.top=drag.y+'px';}
  checkMerge(drag);
  drag.div.style.zIndex=5;
  drag=null;
}

/* ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ */
document.addEventListener('keydown',e=>{
  if(e.key==='l'||e.key==='L'){ window.close(); return; }
  // secret combo (only when E not held)
  if(e.key>='0'&&e.key<='9'&&!eHeld){
    secretBuffer+=e.key;
    if(secretBuffer.length>SECRET.length) secretBuffer=secretBuffer.slice(-SECRET.length);
    if(secretBuffer===SECRET){ unlockAdmin(); secretBuffer=''; }
  }
  if(e.key==='e'||e.key==='E'){ eHeld=true; return; }
  if(eHeld&&e.key>='0'&&e.key<='9'){
    numBuffer+=e.key;
    clearTimeout(numTimer);
    numTimer=setTimeout(()=>{ showRecipeByNum(parseInt(numBuffer)); numBuffer=''; },400);
  }
  if(e.key==='Escape'){ ['ach-panel','stats-panel','fav-panel','recipe-popup'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';}); }
});
document.addEventListener('keyup',e=>{ if(e.key==='e'||e.key==='E'){eHeld=false;} });

function showRecipeByNum(num){
  const sorted=sortedByAZ();
  const el=sorted[num-1]; if(!el)return;
  const rec=recipes[el.name];
  const p=document.getElementById('recipe-popup');
  p.innerHTML=`
    <div style="font-size:10px;color:#888;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;">Rezept #${num}</div>
    <div style="font-size:32px;margin-bottom:4px;">${el.emoji}</div>
    <div style="font-size:16px;font-weight:600;margin-bottom:10px;">${el.name}</div>
    <div style="font-size:13px;color:#888;">${rec||'Grundelement'}</div>
    <div style="margin-top:14px;font-size:11px;color:#555;">Klicken zum Schlie√üen</div>
  `;
  p.style.display='flex'; p.onclick=()=>p.style.display='none';
}

/* ‚îÄ‚îÄ MERGE ‚îÄ‚îÄ */
function dist(a,b){ const dx=(a.x+60)-(b.x+60),dy=(a.y+18)-(b.y+18); return Math.sqrt(dx*dx+dy*dy); }
function checkMerge(it){ if(busy)return; for(const o of items){ if(o.id===it.id)continue; if(dist(it,o)<70){doMerge(it,o);return;} } }

async function doMerge(a,b){
  busy=true;
  const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
  a.div.classList.add('merging'); b.div.classList.add('merging');
  document.getElementById('spinner').style.display='block';
  setTimeout(()=>{remove(a);remove(b);},110);

  // Check existing recipe
  const existingResult=Object.keys(recipes).find(name=>{
    const r=recipes[name];
    return r===`${a.emoji} ${a.name} + ${b.emoji} ${b.name}` ||
           r===`${b.emoji} ${b.name} + ${a.emoji} ${a.name}`;
  });

  if(existingResult){
    const el=discovered.find(e=>e.name===existingResult);
    if(el){ spawn(el,mx,my); toast(el,false); }
    // FIX: also count merges for cached results
    totalMerges++;
    localStorage.setItem('ac_merges', totalMerges);
    checkAchievements();
    document.getElementById('spinner').style.display='none';
    busy=false; return;
  }

  try{
    const res = await ask(a.name,a.emoji,b.name,b.emoji);
    const isNew = !discovered.find(e=>e.name.toLowerCase()===res.name.toLowerCase());
    // FIX: add timestamp for time-sorting
    res.ts = Date.now();
    recipes[res.name] = `${a.emoji} ${a.name} + ${b.emoji} ${b.name}`;
    if(isNew){ res.isNew=true; discovered.push(res); }
    save();
    renderList(document.getElementById('search').value);
    const spawned=spawn(res,mx,my);
    setTimeout(()=>{spawned.div.classList.add('merge-flash');setTimeout(()=>spawned.div.classList.remove('merge-flash'),450);},150);
    toast(res,isNew);
    // FIX: increment INSIDE try so it only counts successful merges
    totalMerges++;
    localStorage.setItem('ac_merges', totalMerges);
    checkAchievements();
  } catch(err){
    console.error('Merge error:', err);
    toast({emoji:'‚ùì',name:'Fehler'},false);
  }
  document.getElementById('spinner').style.display='none';
  busy=false;
}

/* OpenRouter API */
async function ask(na,ea,nb,eb){
  const r=await fetch("https://openrouter.ai/api/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer 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",
      "HTTP-Referer":"https://ahmads-onkel.github.io",
      "X-Title":"Ahmad Craft"
    },
    body:JSON.stringify({
      model:"meta-llama/llama-3.3-8b-instruct:free",
      max_tokens:60,
      messages:[
        {role:"system",content:'You are a crafting game AI. Combine two elements. Reply ONLY with raw JSON: {"emoji":"üåã","name":"Lava"} ‚Äî 1 emoji, 1-2 German words, nothing else.'},
        {role:"user",content:ea+' '+na+' + '+eb+' '+nb}
      ]
    })
  });
  const d=await r.json();
  if(!r.ok) throw new Error("API "+r.status);
  const raw=d.choices[0].message.content;
  const match=raw.match(/\{[^}]+\}/);
  if(!match) throw new Error("No JSON: "+raw);
  return JSON.parse(match[0]);
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function toast(el,isNew){
  const t=document.getElementById('toast');
  t.innerHTML=`<span>${el.emoji}</span><span>${el.name}</span>${isNew?'<span class="tnew">‚ú¶ NEU ENTDECKT</span>':''}`;
  t.style.display='flex'; t.style.animation='none'; void t.offsetWidth; t.style.animation='tin .2s ease';
  clearTimeout(toastT); toastT=setTimeout(()=>t.style.display='none',2200);
}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function remove(it){ it.div.remove(); items=items.filter(c=>c.id!==it.id); if(!items.length) document.getElementById('hint').style.opacity='1'; }
function clearCanvas(){ items.forEach(i=>i.div.remove()); items=[]; document.getElementById('hint').style.opacity='1'; }
function resetAll(){
  if(!confirm('Alle Entdeckungen zur√ºcksetzen?')) return;
  discovered=[...STARTERS]; recipes={};
  clearCanvas(); save(); renderList();
}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
function unlockAdmin(){
  const flash=document.createElement('div');
  flash.style.cssText='position:fixed;inset:0;background:rgba(255,215,0,.15);z-index:9998;pointer-events:none;';
  flash.style.animation='none';
  document.body.appendChild(flash);
  requestAnimationFrame(()=>{
    flash.style.transition='opacity .6s ease';
    flash.style.opacity='0';
    setTimeout(()=>flash.remove(),700);
  });
  showAdminGUI();
}

function showAdminGUI(){
  if(document.getElementById('admin-gui')) return;
  const gui=document.createElement('div');
  gui.id='admin-gui';
  gui.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:${dark?'#111':'#fff'};border:2px solid gold;border-radius:16px;
    padding:24px 28px;z-index:9999;min-width:320px;box-shadow:0 8px 40px rgba(0,0,0,.5);
    font-family:Inter,sans-serif;color:${dark?'#ddd':'#111'};`;
  const ib=`background:${dark?'#1e1e1e':'#f5f5f5'};border:1.5px solid ${dark?'#333':'#ddd'};border-radius:8px;font-size:14px;color:${dark?'#ddd':'#111'};padding:8px 12px;width:100%;margin-bottom:8px;outline:none;font-family:Inter,sans-serif;`;
  gui.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="font-size:15px;font-weight:700;">üëë Admin Panel</div>
      <button onclick="document.getElementById('admin-gui').remove()" style="background:none;border:none;font-size:18px;cursor:pointer;color:${dark?'#aaa':'#666'};">‚úï</button>
    </div>
    <div style="font-size:12px;color:#888;margin-bottom:6px;">Element Name</div>
    <input id="admin-name" placeholder="z.B. Drache" style="${ib}">
    <div style="font-size:12px;color:#888;margin-bottom:6px;">Emoji</div>
    <input id="admin-emoji" placeholder="z.B. üêâ" style="${ib}margin-bottom:16px;">
    <button onclick="adminSpawn()" style="width:100%;padding:10px;background:gold;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;color:#111;transition:opacity .15s;" onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">‚ú¶ Element spawnen</button>
  `;
  document.body.appendChild(gui);
  setTimeout(()=>document.getElementById('admin-name')?.focus(),50);
}

function adminSpawn(){
  const name=(document.getElementById('admin-name')?.value||'').trim();
  const emoji=(document.getElementById('admin-emoji')?.value||'‚ú®').trim();
  if(!name) return;
  const el={emoji:emoji||'‚ú®', name, ts:Date.now()};
  const isNew=!discovered.find(e=>e.name.toLowerCase()===name.toLowerCase());
  if(isNew){ el.isNew=true; discovered.push(el); recipes[el.name]='üëë Admin'; save(); renderList(document.getElementById('search').value); }
  spawn(el);
  toast(el,isNew);
  document.getElementById('admin-gui')?.remove();
  // FIX: mark admin achievement by a proper flag
  if(!achUnlocked.includes('admin')){ achUnlocked.push('admin'); localStorage.setItem('ac_ach',JSON.stringify(achUnlocked)); showAchToast(ACHIEVEMENTS.find(a=>a.id==='admin')); }
}

/* Always dark mode */

/* ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ */
const ACHIEVEMENTS=[
  {id:'first',   icon:'üå±',  name:'Erster Schritt',    desc:'Erste Kombination gemacht!',         check:()=>Object.keys(recipes).length>=1},
  {id:'ten',     icon:'üîü',  name:'Zehn Entdeckungen', desc:'10 Elemente entdeckt',               check:()=>discovered.length>=10},
  {id:'fifty',   icon:'üåü',  name:'F√ºnfzig!',          desc:'50 Elemente entdeckt',               check:()=>discovered.length>=50},
  {id:'hundred', icon:'üíØ',  name:'Hundert!',           desc:'100 Elemente entdeckt',              check:()=>discovered.length>=100},
  {id:'merge10', icon:'‚öóÔ∏è',  name:'Alchemist',          desc:'10 Kombinationen gemacht',           check:()=>totalMerges>=10},
  {id:'merge50', icon:'üß™',  name:'Chemiker',           desc:'50 Kombinationen gemacht',           check:()=>totalMerges>=50},
  {id:'admin',   icon:'üëë',  name:'Admin',              desc:'Admin-Panel gefunden (22112011)',     check:()=>achUnlocked.includes('admin')},
  {id:'fav5',    icon:'‚≠ê',  name:'Sammler',            desc:'5 Favoriten gespeichert',            check:()=>favorites.length>=5},
];

function checkAchievements(){
  ACHIEVEMENTS.forEach(a=>{
    if(!achUnlocked.includes(a.id)&&a.check()){
      achUnlocked.push(a.id);
      localStorage.setItem('ac_ach',JSON.stringify(achUnlocked));
      showAchToast(a);
    }
  });
}

function showAchToast(a){
  if(!a) return;
  const t=document.getElementById('ach-toast');
  t.innerHTML=`${a.icon} Erfolg freigeschaltet: <strong>${a.name}</strong>`;
  t.style.display='flex'; t.style.animation='none'; void t.offsetWidth; t.style.animation='tin .3s ease';
  setTimeout(()=>t.style.display='none',3500);
}

function showAchievements(){
  const list=document.getElementById('ach-list');
  list.innerHTML='';
  ACHIEVEMENTS.forEach(a=>{
    const unlocked=achUnlocked.includes(a.id);
    const div=document.createElement('div');
    div.className='ach-item'+(unlocked?' unlocked':'');
    div.innerHTML=`<div class="ach-icon">${a.icon}</div><div class="ach-info"><div class="ach-name">${a.name}</div><div class="ach-desc">${unlocked?a.desc:'???'}</div></div><div class="ach-lock">${unlocked?'‚úì':'üîí'}</div>`;
    list.appendChild(div);
  });
  document.getElementById('ach-panel').style.display='block';
}

function showStats(){
  const mins=Math.floor((Date.now()-sessionStart)/60000);
  document.getElementById('stats-list').innerHTML=`
    <div class="stat-row"><span class="stat-label">Entdeckte Elemente</span><span class="stat-value">${discovered.length}</span></div>
    <div class="stat-row"><span class="stat-label">Kombinationen gesamt</span><span class="stat-value">${totalMerges}</span></div>
    <div class="stat-row"><span class="stat-label">Favoriten</span><span class="stat-value">${favorites.length}</span></div>
    <div class="stat-row"><span class="stat-label">Erfolge</span><span class="stat-value">${achUnlocked.length} / ${ACHIEVEMENTS.length}</span></div>
    <div class="stat-row"><span class="stat-label">Sitzungsdauer</span><span class="stat-value">${mins} Min.</span></div>
    <div class="stat-row"><span class="stat-label">Admin freigeschaltet</span><span class="stat-value">${achUnlocked.includes('admin')?'‚úì Ja':'‚úó Nein'}</span></div>
  `;
  document.getElementById('stats-panel').style.display='block';
}

function showFavorites(){
  const list=document.getElementById('fav-list');
  list.innerHTML='';
  if(!favorites.length){
    list.innerHTML='<div style="color:#666;font-size:13px;text-align:center;padding:20px;">Noch keine Favoriten.<br>Klicke den ‚≠ê neben einem Element.</div>';
  } else {
    favorites.forEach(name=>{
      const el=discovered.find(e=>e.name===name);
      if(!el) return;
      const d=document.createElement('div');
      d.className='ach-item unlocked';
      d.style.cursor='pointer';
      d.innerHTML=`<div class="ach-icon">${el.emoji}</div><div class="ach-info"><div class="ach-name">${el.name}</div><div class="ach-desc">Auf Fl√§che spawnen</div></div>`;
      d.onclick=()=>{spawn(el);closePanel('fav-panel');};
      list.appendChild(d);
    });
  }
  document.getElementById('fav-panel').style.display='block';
}

function toggleFav(name){
  const idx=favorites.indexOf(name);
  if(idx>=0) favorites.splice(idx,1); else favorites.push(name);
  localStorage.setItem('ac_favs',JSON.stringify(favorites));
  renderList(document.getElementById('search').value);
  checkAchievements();
}
</script>
</body>
</html>
